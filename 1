/*
** proxy.go
** Author: Marin Alcaraz
** Mail   <marin.alcaraz@gmail.com>
** Started on  Fri Feb 20 18:44:36 2015 Marin Alcaraz
** Last update Tue Feb 24 23:41:33 2015 Marin Alcaraz
 */

package main

import (
	"bufio"
	"bytes"
	"fmt"
	"io"
	"log"
	"net/http"
	"os"
)

type blackList []string

var hostBlackList blackList

func check(err error) {
	if err != nil {
		fmt.Println(err)
		panic(err)
	}

}

func (bl *blackList) populateBlackList() {
	//Is there any better way to do this? slice size = 1
	hostBlackList := make(blackList, 1)
	blackListFile, err := os.Open("blacklist.txt")
	if err != nil {
		fmt.Println(err)
		return
	}

	defer blackListFile.Close()
	reader := bufio.NewReader(blackListFile)
	blackTarget, err := reader.ReadBytes('\n')
	for blackTarget != nil {
		fmt.Println(blackTarget)
		hostBlackList = append(hostBlackList, string(blackTarget))
		blackTarget, err := reader.ReadBytes('\n')
		check(err)
	}

	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

}

func (bl *blackList) blackListContains(target string) bool {
	for _, val := range hostBlackList {
		if val == target {
			return true
		}
	}
	return false
}

func handler(w http.ResponseWriter, req *http.Request) {
	target := req.URL.String()

	//Todo: pattern matching!
	if hostBlackList.blackListContains(target) {
		io.Copy(w, nil)
	} else {

		client := &http.Client{}

		//What is wrong with the POSTS requests?
		req.ParseForm()

		data := req.Form.Encode()
		bufferedData := bytes.NewBufferString(data)

		proxyRequest, _ := http.NewRequest(req.Method, target, bufferedData)
		proxyRequest.Form = req.Form
		proxyRequest.ParseForm()
		proxyResponse, _ := client.Do(proxyRequest)

		defer proxyRequest.Body.Close()

		w.Header().Set("Content-Type", proxyResponse.Header.Get("Content-Type"))
		io.Copy(w, proxyResponse.Body)

	}

}

func main() {

	hostBlackList.populateBlackList()
	http.HandleFunc("/", handler)
	fmt.Println("[!]Local service binded on :8080/")
	err := http.ListenAndServe(":8080", nil)
	if err != nil {
		log.Fatal(err)
	}
}
